# tasks file to install docker on debian
---
- name: Install Docker on Debian
  block:
    - name: Install required packages
      apt:
        name:
          - curl
          - apt-transport-https
          - ca-certificates
          - gnupg2
          - software-properties-common
        state: present
      become: true

    - name: Add Docker GPG key
      shell: 'curl -fsSL https://download.docker.com/linux/$(. /etc/os-release; echo "$ID")/gpg | sudo apt-key add -'
      become: true
      changed_when: false

    - name: Add Docker apt repository
      shell: 'add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/$(. /etc/os-release; echo "$ID") $(lsb_release -cs) stable"'
      become: true

    - name: Update apt cache
      apt:
        update_cache: yes
      become: true

    - name: Install Docker CE
      apt:
        name: docker-ce
        state: present
      become: true

  rescue:
    - name: Display Docker installation error
      debug:
        msg: "Failed to install Docker on Debian. Please check repository configuration and network connectivity."

    - name: Fail with detailed message
      fail:
        msg: "Docker installation failed. Check that the Docker repository is accessible and your system is supported."

  when: (ansible_facts["os_family"] == 'Debian')

### pacman
- name: Install Docker on Arch Linux
  block:
    - name: Install curl
      pacman:
        name: curl
        state: present
      become: true

    - name: Install Docker
      pacman:
        name: docker
        state: present
        update_cache: yes
      become: true

    - name: Enable and start docker service
      systemd:
        name: docker
        enabled: yes
        state: started
      become: true

  rescue:
    - name: Display Docker installation error
      debug:
        msg: "Failed to install Docker on Arch Linux. Please check package availability."

    - name: Fail with detailed message
      fail:
        msg: "Docker installation failed on Arch Linux. Check your pacman configuration and network."

  when: (ansible_facts["os_family"] == 'Archlinux')

## end env

- name: Add user to docker group
  block:
    - name: Add user to docker group
      user:
        name: "{{ non_root_user }}"
        groups: docker
        append: yes
      become: true

  rescue:
    - name: Warn about docker group failure
      debug:
        msg: "Warning: Could not add user {{ non_root_user }} to docker group. User may need to log out and back in, or the group may not exist yet."
