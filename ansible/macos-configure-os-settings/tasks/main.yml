---
- include_vars:
    file: "{{ macos_settings }}"
    name: macos_settings_config

## DOCK SETTINGS
# Get current dock configuration (excluding recentApps which macOS adds automatically)
- name: Get current dock items
  shell: dockutil --list | grep -v "recentApps" | awk -F'\t' '{print $1}'
  register: current_dock_items
  changed_when: false
  when: macos_settings_config.dock is defined

# Build expected dock configuration as ordered list
- name: Build expected dock configuration
  set_fact:
    expected_dock_items: "{{ (macos_settings_config.dock.persistent_apps | default([]) + macos_settings_config.dock.other_apps | default([])) | map(attribute='name') | list }}"
  when: macos_settings_config.dock is defined

# Parse current dock items into a list (preserving order)
- name: Parse current dock items
  set_fact:
    current_dock_names: "{{ current_dock_items.stdout_lines | map('trim') | list }}"
  when: macos_settings_config.dock is defined and current_dock_items.stdout_lines is defined

# Check if configured apps are in exact order at start of dock (ignore extra apps after)
- name: Check if configured apps are in correct positions
  set_fact:
    dock_needs_update: "{{ expected_dock_items != (current_dock_names[:expected_dock_items | length] | list) }}"
  when: macos_settings_config.dock is defined

# Debug dock configuration (optional - set macos_dock_debug: true to enable)
- name: Debug dock configuration
  debug:
    msg:
      - "Expected items ({{ expected_dock_items | length }}): {{ expected_dock_items }}"
      - "Current items in expected positions ({{ current_dock_names[:expected_dock_items | length] | length }}): {{ current_dock_names[:expected_dock_items | length] }}"
      - "All current items ({{ current_dock_names | length }}): {{ current_dock_names }}"
      - "Needs update: {{ dock_needs_update | default(false) }}"
      - "Differences: {{ expected_dock_items | zip(current_dock_names[:expected_dock_items | length]) | selectattr('0', 'ne', '1') | list }}"
  when: macos_settings_config.dock is defined and (macos_dock_debug | default(false) | bool)

# Remove All Dock Items (only if changes needed)
- name: Remove all items from Dock
  shell: dockutil --remove all 
  when: macos_settings_config.dock is defined and dock_needs_update | default(false) | bool
  
# Add Dock Items Apps
- name: Add in Dock to Persistent App section
  shell: |
    dockutil --add '{{ item.path }}' --label '{{ item.name }}' --position '{{ ansible_loop.index }}' --section apps
    sleep {{ dock_operation_delay }}
  loop: "{{ macos_settings_config.dock.persistent_apps|flatten(levels=1) }}"
  loop_control:
    index_var: index
    extended: true
    extended_allitems: false
  when: macos_settings_config.dock.persistent_apps is defined and item.type == 'app' and dock_needs_update | default(false) | bool

# Add Dock Items Apps Folders
- name: Add in Dock to Persistent App section folders
  shell: |
    dockutil --add '{{ item.path }}' --label '{{ item.name }}' --position '{{ ansible_loop.index }}' --section apps --view '{{ item.folder_style }}' --display '{{ item.type }}' --sort '{{ item.folder_sort }}'
    sleep {{ dock_operation_delay }}
  loop: "{{ macos_settings_config.dock.persistent_apps|flatten(levels=1) }}"
  loop_control:
    index_var: index
    extended: true
    extended_allitems: false
  when: macos_settings_config.dock.persistent_apps is defined and item.type == 'folder' and dock_needs_update | default(false) | bool

# Add Dock Items Others
- name: Add in Dock to Other app section 
  shell: |
    dockutil --add '{{ item.path }}' --label '{{ item.name }}' --position '{{ ansible_loop.index }}' --section others
    sleep {{ dock_operation_delay }}
  loop: "{{ macos_settings_config.dock.other_apps | flatten(levels=1) }}"
  loop_control:
    index_var: index
    extended: true
    extended_allitems: false
  when: macos_settings_config.dock.other_apps is defined and item.type == 'app' and dock_needs_update | default(false) | bool

# Add Dock Items Apps Folders
- name: Add in Dock to Other App section folders
  shell: |
    dockutil --add '{{ item.path }}' --label '{{ item.name }}' --position '{{ ansible_loop.index }}' --section others --view '{{ item.folder_style }}' --display '{{ item.type }}' --sort '{{ item.folder_sort }}'
    sleep {{ dock_operation_delay }}
  loop: "{{ macos_settings_config.dock.other_apps | flatten(levels=1) }}"
  loop_control:
    index_var: index
    extended: true
    extended_allitems: false
  when: macos_settings_config.dock.other_apps is defined and item.type == 'folder' and dock_needs_update | default(false) | bool

## MACOS DEFAULTS TERMINAL PLIST SETTINGS
# Delete defaults
- osx_defaults:
    domain: '{{ item.domain }}'
    key: '{{ item.key}}'
    state: absent
  loop: "{{ macos_settings_config.osx_defaults | default({}) }}"
  when: item.state == 'absent'

# Modify (add,update) defaults
- osx_defaults:
    domain: '{{ item.domain }}'
    key: '{{ item.key }}'
    type: '{{ item.type }}'
    value: '{{ item.value }}'
    state: present
  loop: "{{ macos_settings_config.osx_defaults | default({}) }}"
  when: item.state == 'present'